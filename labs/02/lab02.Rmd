---
title: "lab02"
author: "Chase Robertson"
date: "2022-08-02"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Import

1. Curl to download weather data
```{bash}
if [ ! -f akl.json ]; then
curl -o akl.json 'https://archive-api.open-meteo.com/v1/era5?latitude=-36.85&longitude=174.77&start_date=1980-01-01&end_date=2022-06-30&daily=temperature_2m_max,temperature_2m_min&timezone=Pacific%2FAuckland'
fi
```

2. Read into R
```{r}
library(jsonlite)
jd <- read_json("akl.json", simplifyVector = TRUE)
str(jd)
```

## Clean

3. Create dataframe from jd

```{r}
d <- data.frame(day = as.Date(jd$daily$time), 
                min = jd$daily$temperature_2m_min, 
                max = jd$daily$temperature_2m_max)
str(d)
```

## Explore

4. Data verification

```{r}
sum(is.na(d))
summary(d)
```

## Model

5. Aggregate to annual avg temp.

```{r}
d$year <- as.integer(format(d$day, "%Y"))
d$avg <- (d$min + d$max) / 2
avg <- aggregate(avg ~ year, data=d, FUN=mean)
str(avg)
```

```{r}
train <- subset(avg, year <= 2014)
test <- subset(avg, year > 2014)

mean_model <- mean(train$avg)
linear_model <- lm(avg ~ year, data=train)

mean_pred <- rep(mean_model, nrow(test))
linear_pred <- predict(linear_model, test)

rmse <- function(actual, predicted) {
    sqrt(mean((actual - predicted) ^ 2))
}

cat("RMSE for mean:", fill=T)
rmse(test$avg, mean_pred)
cat("RMSE for linear model:", fill=T)
rmse(test$avg, linear_pred)

plot(avg ~ year, data=avg, type='l', 
     xlab='Year', ylab='Annual Avg Temperature')
abline(h=mean_model, col='blue')
abline(linear_model, col='red')
abline(v=test$year[1], lty=2)
```

The test data ends in June of 2022, so the average annual temperature of 2022 does not include winter or spring temperatures! This causes the annual average of 2022 to be significantly higher than other years. Ways to handle this situation include dropping 2022 from the test set, or imputing the missing 2022 months' temperatures with those of recent years or an average of previous years' winter months.

```{r}
tail(test)
d$month <- as.integer(format(d$day, "%m"))

train <- subset(d, year <= 2014)
test <- subset(d, year > 2014)

train_monthly_avgs <- aggregate(avg ~ month, data=train, FUN=mean)
avg2022 <- c(subset(test, year >= 2022, select=avg),
             subset(train_monthly_avgs, month >= 7, select=avg))
avg2022
```
```{r}

mean_model <- mean(train$avg)
linear_model <- lm(avg ~ year, data=train)

mean_pred <- rep(mean_model, nrow(test))
linear_pred <- predict(linear_model, test)

cat("RMSE for mean:", fill=T)
rmse(test$avg, mean_pred)
cat("RMSE for linear model:", fill=T)
rmse(test$avg, linear_pred)

plot(avg ~ year, data=avg, type='l', 
     xlab='Year', ylab='Annual Avg Temperature')
abline(h=mean_model, col='blue')
abline(linear_model, col='red')
abline(v=test$year[1], lty=2)
```
