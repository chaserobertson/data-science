---
title: "STATS 769 Lab 01"
author: "Chase Robertson"
date: '2022-07-27'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Unix

1. Unix commands to create lab01 directory, and navigate to that directory

```{bash eval=FALSE}
mkdir lab01
cd lab01
```

2. Shell command to show info about all data files inc. size in bytes

```{bash eval=FALSE}
ls -l vehicles-*.csv
```

3. Number of lines in vehicles-2020.csv

```{bash eval=FALSE}
wc -l vehicles-2020.csv
```

4. Extract records with specific HSC code to a new file and show number of lines
```{bash eval=FALSE}
grep 8703231915 vehicles-*.csv > car-imports.data
wc -l car-imports.data 
```

5. Get total count for all HS codes and print greatest 5
```{bash eval=FALSE}
cut -d',' -f2 vehicles-*.csv | sort | uniq -c | sort | tail -5
```

6. Create new csv file with vehicles matching the listed HS codes
```{bash eval=FALSE}
head -1 vehicles-2000.csv > new-car-imports.csv
RAW="8703218006, 8703228003, 8703238003, 8703248003, 8703211915, 8703221915, 8703231915, 8703241915"
HSC=$(sed 's/, /|/g' <<< $RAW)
egrep -h $HSC vehicles-*.csv >> new-car-imports.csv
```

# Import

7. Read the previously created file into R
```{r}
cars <- read.csv("new-car-imports.csv")
```

# Clean

8. Replace colnames, convert numeric columns, and create Date column
```{r}
names(cars) <- c("Month", "HSC", "HSDescription", "Unit", "Country",
                 "VFD", "CIF", "Quantity", "Status")
num_cols = c("VFD", "CIF", "Quantity")
cars[num_cols] <- lapply(cars[num_cols],
                        function(x) {as.numeric(gsub(",", "", x))})
cars$Date <- as.Date(paste0(cars$Month, "01"), format="%Y%m%d")
str(cars)
```

# Explore

9. Create barplot of total VFD per country
```{r}
tab <- tapply(cars$VFD, cars$Country, sum)
par(mar=c(2,12,1,1))
barplot(tab[order(tab)], horiz=T, las=1)
```

Improved barplot
```{r}
tab <- tapply(cars$VFD, cars$Country, sum)
par(mar=c(2,12,1,1))
barplot(tail(tab[order(tab)], 10), horiz=T, las=1, log="x")
```

10. Compute and plot monthly import value per HS code over time
```{r}
hsc <- xtabs(VFD ~ Month + HSC, data=cars) / 1e6
matplot(hsc, type='l', lty=1, xaxt="n", xlab="Month",
        ylab="Value for Duty in millions NZD",
        main="Total Monthly Import Value by HS Code")
axis(1, at=seq(0, 250, by=60), labels=seq(2000, 2020, by=5))
```

Something major happened in 2017

```{r}
matplot(hsc[192:216,], type='l', lty=1, xaxt="n", xlab="Month",
        ylab="Value for Duty in millions NZD",
        main="Total Monthly Import Value by HS Code")
axis(1, at=seq(0, 24, by=12), labels=seq(2016, 2018, by=1))
```

# Model

11. 
```{r}
# narrow scope to Germany, scale vfd to millions NZD, sort by Month
germany <- aggregate(VFD ~ Date, data=subset(cars, Country == 'Germany'), sum)
germany$VFD <- germany$VFD / 1e6
germany <- germany[order(germany$Date),]

# reserve final 10% for testing
n <- nrow(germany)
pivot <- floor(n * 0.9)
train <- germany[1:pivot,]
test <- germany[-(1:pivot),]

mean_model <- mean(train$VFD)
linear_model <- lm(VFD ~ Date, data=train)
mean_pred <- rep(mean_model, length(test))
fit_pred <- predict(linear_model, test)

rmse <- function(actual, predicted) {
    sqrt(mean((actual - predicted) ^ 2))
}

cat("RMSE for mean:", fill=T)
rmse(test$VFD, mean_pred)
cat("RMSE for linear model:", fill=T)
rmse(test$VFD, fit_pred)
```

Plot of model predictions

```{r}
plot(VFD ~ Date, data=germany, type='l', 
     xlab='Year', ylab='Value for Duty (millions NZD))')
abline(h=mean_model, col='blue')
abline(linear_model, col='red')
abline(v=test$Date[1], lty=2)
```

# Summary

